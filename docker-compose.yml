# version: "3.9"

# services:
#   db:
#     image: postgres:15
#     container_name: todo_db
#     restart: always
#     environment:
#       POSTGRES_DB: todo
#       POSTGRES_USER: todo_user
#       POSTGRES_PASSWORD: todo_pass
#     volumes:
#       - postgres_data:/var/lib/postgresql/data
#     ports:
#       - "5434:5432"

#   redis:
#     image: redis:7
#     container_name: todo_redis
#     restart: always
#     ports:
#       - "6380:6379"

#   backend:
#     build: ./backend
#     container_name: todo_backend
#     depends_on:
#       - db
#       - redis
#     ports:
#       - "8000:8000"
#     environment:
#       - DATABASE_URL=postgres://todo_user:todo_pass@db:5432/todo
#       - REDIS_URL=redis://redis:6379/0
#   celery:
#     build: ./backend
#     container_name: todo_celery
#     command: celery -A config worker -l info
#     volumes:
#       - ./backend:/app/backend
#       - ./bot:/app/bot  
#     env_file:
#       - .env
#     environment:
#        - PYTHONPATH=/app 
#        - DJANGO_SETTINGS_MODULE=backend.config.settings 
#     depends_on:
#       - backend
#       - redis  
#   celery-beat:
#     build: ./backend
#     container_name: todo_celery_beat
#     command: celery -A config beat -l info
#     volumes:
#       - ./backend:/app/backend
#     env_file:
#       - .env
#     depends_on:
#       - redis    
#   bot:
#     build:
#       context: .
#       dockerfile: bot/Dockerfile   
#     container_name: todo_bot
#     restart: always
#     env_file:
#       - .env
#     environment:
#       - DJANGO_SETTINGS_MODULE=backend.config.settings    
#     depends_on:
#       - backend
#       - redis    
#     volumes:
#       - ./backend:/app/backend   
#       - ./bot:/app/bot
   
# volumes:
#   postgres_data:
version: "3.9"

services:
  # --- Postgres ---
  db:
    image: postgres:15
    container_name: todo_db
    restart: always
    environment:
      POSTGRES_DB: todo
      POSTGRES_USER: todo_user
      POSTGRES_PASSWORD: todo_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5434:5432"

  # --- Redis ---
  redis:
    image: redis:7
    container_name: todo_redis
    restart: always
    ports:
      - "6380:6379"

  # --- Django backend ---
  backend:
    build: ./backend
    container_name: todo_backend
    working_dir: /app
    depends_on:
      - db
      - redis
    ports:
      - "8000:8000"
    env_file:
      - .env    
    environment:
      - DATABASE_URL=postgres://todo_user:todo_pass@db:5432/todo
      - REDIS_URL=redis://redis:6379/0
      - DJANGO_SETTINGS_MODULE=backend.config.settings
      - PYTHONPATH=/app
    volumes:
      - ./backend:/app/backend

  # --- Celery worker ---
  celery:
    build: ./backend
    container_name: todo_celery
    command: celery -A config worker -l info
    working_dir: /app
    depends_on:
      - backend
      - redis
    env_file:
      - .env   
    environment:
      - DJANGO_SETTINGS_MODULE=backend.config.settings
      - PYTHONPATH=/app
    volumes:
      - ./backend:/app/backend
      - ./bot:/app/bot

  # --- Celery beat scheduler ---
  celery-beat:
    build: ./backend
    container_name: todo_celery_beat
    command: celery -A config beat -l info
    working_dir: /app
    depends_on:
      - backend
      - redis
    env_file:
      - .env    
    environment:
      - DJANGO_SETTINGS_MODULE=backend.config.settings
      - PYTHONPATH=/app
    volumes:
      - ./backend:/app/backend
      - ./bot:/app/bot

  # --- Telegram Bot ---
  bot:
    build:
      context: .
      dockerfile: bot/Dockerfile
    container_name: todo_bot
    restart: always
    working_dir: /app
    depends_on:
      - backend
      - redis
    environment:
      - DJANGO_SETTINGS_MODULE=backend.config.settings
      - PYTHONPATH=/app/backend
    env_file:
      - .env  
    volumes:
      - ./backend:/app/backend
      - ./bot:/app/bot

volumes:
  postgres_data: